<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Merry Christmas</title>
    <link href="https://fonts.googleapis.com/css2?family=Mountains+of+Christmas:wght@400;700&family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; background-color: #010204; overflow: hidden; user-select: none; touch-action: none; }
        canvas { display: block; cursor: grab; }
        .font-loader { position: absolute; opacity: 0; font-family: 'Dancing Script'; pointer-events: none; }

        /* --- 1. 惊喜盒子 (手机适配版) --- */
        #gift-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            background-color: #010204; z-index: 100; cursor: pointer;
            transition: opacity 1.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .text-top { text-align: center; font-family: 'Mountains of Christmas', cursive; margin-bottom: 40px; }
        .gift-for { font-size: 14px; color: rgba(255, 215, 0, 0.7); letter-spacing: 5px; margin-bottom: 5px; font-weight: 700; }
        .dear-friend { font-size: 32px; color: #ffffff; text-shadow: 0 0 20px rgba(255, 255, 255, 0.3); }
        .gift-container { display: flex; flex-direction: column; align-items: center; animation: gift-float 2.5s infinite ease-in-out; }
        .gift-box { width: 120px; height: 120px; background: linear-gradient(135deg, #d40000 0%, #a00000 100%); position: relative; border-radius: 10px; box-shadow: 0 15px 40px rgba(187, 0, 0, 0.4); }
        .gift-box::before { content: ''; position: absolute; width: 22px; height: 100%; background: #FFD700; left: 50%; transform: translateX(-50%); }
        .gift-box::after { content: ''; position: absolute; height: 22px; width: 100%; background: #FFD700; top: 50%; transform: translateY(-50%); }
        .bow-l, .bow-r { position: absolute; width: 45px; height: 40px; border: 10px solid #FFD700; border-radius: 50% 50% 10% 50%; top: -25px; left: 15px; transform: rotate(-20deg); }
        .bow-r { left: 60px; border-radius: 50% 50% 50% 10%; transform: rotate(20deg); }
        .text-bottom { margin-top: 30px; color: #FFD700; font-family: 'Mountains of Christmas', cursive; font-size: 16px; opacity: 0.8; }
        @keyframes gift-float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }

        /* --- 2. 主场景 UI --- */
        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; opacity: 0; transition: opacity 2s; }
        .top-left-text { position: absolute; top: 30px; left: 25px; font-family: 'Mountains of Christmas', cursive; }
        .merry-christmas { font-size: 28px; color: #FFD700; font-weight: 700; }
        .controls-hint { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); font-family: sans-serif; font-size: 11px; color: rgba(255, 255, 255, 0.3); white-space: nowrap; }

        /* --- 3. 贺卡弹窗 (手机适配版) --- */
        #pop-card-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); z-index: 199; display: none; opacity: 0; transition: opacity 0.5s; }
        #pop-card {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.8);
            width: 85vw; max-height: 75vh; background: linear-gradient(135deg, #8b0000 0%, #d40000 100%);
            border: 6px solid #ffd700; border-radius: 20px; z-index: 200; display: none; opacity: 0;
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); padding: 25px; color: #fff; font-family: 'Dancing Script', cursive; overflow-y: auto;
        }
        #pop-card.active, #pop-card-overlay.active { display: block; opacity: 1; }
        #pop-card.active { transform: translate(-50%, -50%) scale(1); }
        .card-inner { border: 1px solid rgba(255, 215, 0, 0.3); padding: 20px; }
        .card-salutation { font-size: 28px; color: #ffd700; margin-bottom: 10px; }
        .card-content { font-size: 20px; line-height: 1.5; }
        .card-closing { text-align: right; color: #ffd700; font-size: 24px; margin-top: 20px; }
        .close-btn { position: absolute; top: 10px; right: 15px; color: #fff; font-size: 28px; font-family: sans-serif; }
    </style>
</head>
<body>
    <div class="font-loader">Load Font</div>
    <audio id="bgm" loop><source src="christmas.mp3" type="audio/mpeg"></audio>

    <div id="gift-screen" onclick="revealTree()">
        <div class="text-top"><div class="gift-for">GIFT FOR</div><div class="dear-friend">My Dear Friend</div></div>
        <div class="gift-container">
            <div class="gift-box"><div class="bow-l"></div><div class="bow-r"></div></div>
            <div class="text-bottom">Tap to open your surprise ✨</div>
        </div>
    </div>

    <div id="overlay">
        <div class="top-left-text"><div class="merry-christmas">Merry Christmas</div></div>
        <div class="controls-hint">Tap the card to read | Slide to rotate</div>
    </div>

    <div id="pop-card-overlay" onclick="closeCard()"></div>
    <div id="pop-card">
        <div class="close-btn" onclick="closeCard()">✕</div>
        <div class="card-inner">
            <div class="card-salutation">Dear Cobey,</div>
            <div class="card-content">As the year draws to a close, I wanted to thank you for our partnership. Working with you is a journey of trust that we deeply treasure.<br><br>Wishing you and your family a Christmas filled with warmth, laughter, and peace.</div>
            <div class="card-closing">Best regards,<br>Jeremy</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        let scene, camera, renderer, treeGroup, cardMesh, snowflakes;
        let isRevealed = false, autoRotate = true;
        let raycaster = new THREE.Raycaster(), mouse = new THREE.Vector2();

        function revealTree() {
            if(isRevealed) return;
            // 手机端必须在点击事件里播放音乐
            const audio = document.getElementById('bgm'); 
            if(audio) audio.play().catch(() => {});
            isRevealed = true;
            document.getElementById('gift-screen').style.opacity = '0';
            
            document.fonts.ready.then(() => {
                setTimeout(() => {
                    document.getElementById('gift-screen').style.display = 'none';
                    document.getElementById('overlay').style.opacity = '1';
                    initScene();
                }, 1000);
            });
        }

        function createTexture(text) {
            const canvas = document.createElement('canvas');
            canvas.width = 256; canvas.height = 340;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#b30000'; ctx.fillRect(0,0,256,340);
            ctx.strokeStyle = '#ffd700'; ctx.lineWidth = 10; ctx.strokeRect(10,10,236,320);
            ctx.fillStyle = '#ffd700'; ctx.textAlign = 'center';
            ctx.font = '700 42px "Dancing Script", cursive';
            ctx.fillText(text, 128, 180);
            return new THREE.CanvasTexture(canvas);
        }

        function initScene() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 1, 1000);
            camera.position.set(0, 10, 40);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.body.appendChild(renderer.domElement);

            treeGroup = new THREE.Group();
            scene.add(treeGroup);

            // 圣诞树 (手机端优化：30,000个粒子)
            const tGeom = new THREE.BufferGeometry(), tP = [], tC = [];
            for (let i = 0; i < 30000; i++) {
                let h = Math.random() * 26;
                let r = (26 - h) * 0.4 * Math.sqrt(Math.random());
                let theta = Math.random() * Math.PI * 2;
                tP.push(Math.cos(theta)*r, h-10, Math.sin(theta)*r);
                tC.push(0, 0.2 + Math.random()*0.3, 0.1);
            }
            tGeom.setAttribute('position', new THREE.Float32BufferAttribute(tP, 3));
            tGeom.setAttribute('color', new THREE.Float32BufferAttribute(tC, 3));
            treeGroup.add(new THREE.Points(tGeom, new THREE.PointsMaterial({ size: 0.1, vertexColors: true })));

            // 贺卡
            cardMesh = new THREE.Mesh(
                new THREE.BoxGeometry(3, 4, 0.1),
                new THREE.MeshStandardMaterial({ map: createTexture('For You') })
            );
            cardMesh.position.set(6, 2, 0);
            treeGroup.add(cardMesh);

            // 雪花
            const sGeom = new THREE.BufferGeometry(), sP = [];
            for(let i=0; i<800; i++) sP.push((Math.random()-0.5)*100, Math.random()*50, (Math.random()-0.5)*100);
            sGeom.setAttribute('position', new THREE.Float32BufferAttribute(sP, 3));
            snowflakes = new THREE.Points(sGeom, new THREE.PointsMaterial({ color: 0xffffff, size: 0.15, transparent: true, opacity: 0.6 }));
            scene.add(snowflakes);

            scene.add(new THREE.AmbientLight(0xffffff, 0.8));
            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            if(autoRotate && treeGroup) treeGroup.rotation.y += 0.005;
            if(snowflakes) {
                const p = snowflakes.geometry.attributes.position.array;
                for(let i=1; i<p.length; i+=3) { p[i] -= 0.05; if(p[i] < -10) p[i] = 30; }
                snowflakes.geometry.attributes.position.needsUpdate = true;
            }
            renderer.render(scene, camera);
        }

        function closeCard() {
            document.getElementById('pop-card').classList.remove('active');
            document.getElementById('pop-card-overlay').classList.remove('active');
            autoRotate = true;
        }

        // 手机触控交互
        window.addEventListener('touchstart', (e) => {
            const touch = e.touches[0];
            mouse.x = (touch.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(touch.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            if (raycaster.intersectObject(cardMesh).length > 0) {
                document.getElementById('pop-card').classList.add('active');
                document.getElementById('pop-card-overlay').classList.add('active');
                autoRotate = false;
            } else {
                autoRotate = false;
            }
        });
        window.addEventListener('touchend', () => { if(!document.getElementById('pop-card').classList.contains('active')) autoRotate = true; });
        window.addEventListener('touchmove', (e) => {
            if(!autoRotate && treeGroup) {
                treeGroup.rotation.y += (e.changedTouches[0].pageX - (window.innerWidth/2)) * 0.0001;
            }
        });
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
